---
// Google Analytics Consent Mode pour Système Viral
// IMPORTANT: Remplacer par le nouveau GA Measurement ID pour systemeviral.com
const GA_ID = import.meta.env.PUBLIC_GA_MEASUREMENT_ID || "G-EN1Y8Y7QLM";
---

<script
    is:inline
    set:html={`(function(){
  var GA_MEASUREMENT_ID = ${JSON.stringify(GA_ID)};
  if(!GA_MEASUREMENT_ID || GA_MEASUREMENT_ID === "G-XXXXXXXXXX"){
    // Désactiver GA si pas d'ID valide
    window.dataLayer = window.dataLayer || [];
    window.gtag = function(){ window.dataLayer.push(arguments); };
    window.__consent = { accept:function(){}, refuse:function(){} };
    return;
  }

  window.dataLayer = window.dataLayer || [];
  function gtag(){ window.dataLayer.push(arguments); }
  window.gtag = gtag;

  gtag('consent','default',{
    ad_storage:'denied',
    analytics_storage:'denied',
    ad_user_data:'denied',
    ad_personalization:'denied'
  });

  var s=document.createElement('script');
  s.async=true;
  s.src='https://www.googletagmanager.com/gtag/js?id='+GA_MEASUREMENT_ID;
  document.head.appendChild(s);
  s.onload=function(){
    gtag('js', new Date());
    gtag('config', GA_MEASUREMENT_ID, { anonymize_ip: true });
  };

  window.__consent={
    accept:function(){
      gtag('consent','update',{
        ad_storage:'granted',
        analytics_storage:'granted',
        ad_user_data:'granted',
        ad_personalization:'granted'
      });
      gtag('event','cookie_accept');
      // Forcer un page_view immédiat pour déclencher un hit dès l'acceptation
      try {
        gtag('event','page_view', {
          page_title: document.title,
          page_location: window.location.href,
          page_path: window.location.pathname
        });
      } catch (_) {}
    },
    refuse:function(){
      gtag('event','cookie_refuse');
    }
  };
})();`}
/>
